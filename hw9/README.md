# ДЗ 9: Многопоточность в Go

Добавлена поддержка конкурентных операций и таймаутов запросов.

## Что изменилось

- Добавлен middleware с таймаутом для всех HTTP-запросов
- Реализован конкурентный расчет отчета с использованием горутин
- Добавлен heartbeat во время длительных операций
- Все операции поддерживают отмену через context

## Структура

Та же что и в ДЗ 8, плюс:
- Middleware с таймаутом в Gateway
- Конкурентный расчет отчета в Service

## Запуск

1. Настроить переменные окружения:
```bash
export DATABASE_URL="postgres://postgres:postgres@localhost:5432/cashapp?sslmode=disable"
```

2. Выполнить миграции:
```bash
cd ledger
goose -dir migrations postgres "$DATABASE_URL" up
```

3. Запустить сервер:
```bash
cd gateway
go run main.go
```

## API

- `POST /api/budgets` - создать бюджет
- `GET /api/budgets` - получить бюджеты
- `POST /api/transactions` - создать транзакцию
- `GET /api/transactions` - получить транзакции
- `GET /api/reports/summary?from=YYYY-MM-DD&to=YYYY-MM-DD` - отчет по категориям

## Эндпоинт отчета

**GET /api/reports/summary**

Параметры:
- `from` - начальная дата (формат: YYYY-MM-DD)
- `to` - конечная дата (формат: YYYY-MM-DD)

Пример запроса:
```bash
curl "http://localhost:8080/api/reports/summary?from=2025-10-20&to=2025-10-22"
```

Пример ответа:
```json
{
  "еда": 650.0,
  "транспорт": 300.0
}
```

Расчет выполняется параллельно для каждой категории с использованием горутин. Во время расчета в лог выводится heartbeat каждые 400 мс.

## Таймауты запросов

По умолчанию для каждого HTTP-запроса устанавливается таймаут **2 секунды**.

### Настройка таймаута

Таймаут можно изменить через переменную окружения `REQUEST_TIMEOUT` (в миллисекундах):

```bash
export REQUEST_TIMEOUT=5000  # 5 секунд
```

### Поведение при таймауте

Если запрос не успевает выполниться за отведенное время:
- Возвращается код `504 Gateway Timeout`
- Тело ответа содержит JSON: `{"error":"request timeout"}`
- Все операции прерываются через context
- Горутины корректно завершаются
- Heartbeat останавливается

### Пример с таймаутом

Для тестирования можно установить очень маленький таймаут:
```bash
export REQUEST_TIMEOUT=50  # 50 миллисекунд
```

При запросе к `/api/reports/summary` с большим объемом данных запрос будет прерван по таймауту.

## Что изменилось

- Middleware с таймаутом применяется ко всем запросам
- Отчет рассчитывается параллельно для каждой категории
- Heartbeat показывает прогресс длительных операций
- Все SQL-запросы используют Context версии для поддержки отмены
